#!/bin/sh
set -o errexit
set -o nounset
set -o pipefail
RRH_VER="source"
RRH_BIN="."
RRH_VAR="$HOME/.cache/rrh-dev/var"
RRH_ETC="$HOME/.cache/rrh-dev/etc"

if [ ! "$#" -eq 1 ]; then
    echo "Usage: rrh-remove-action ID"
    echo "Remove a action. May require root."
    echo "This utility will refuse to remove the latest action."
    echo "RRH $RRH_VER"
    exit 8
fi

if [ "$(id -un)" != "root" ]; then
    if [ -f "$RRH_ETC/auto_sudo" ]; then
        "$RRH_BIN/rrh-doas" "root" "$0" "$@"
        exit $?
    else
        echo "You may need run this command as root"
    fi
fi

for ((i=0; i<${#1}; i++)); do
    if [ "${1:i:1}" == "." ] || [ "${1:i:1}" == "/" ]; then
        echo "illegal char '${1:i:1}' in action id"
        exit 12
    fi
done

if [ ! "$1" == "$(cat $RRH_VAR/last)" ]; then
    rm -r "$RRH_VAR/action/$1/"
else
    echo "can not remove last action"
    echo "if you are sure what you are doing, run:"
    echo "  # rm -r $RRH_VAR/action/$1/"
    exit 15
fi
