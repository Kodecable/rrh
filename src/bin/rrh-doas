#!/bin/sh
set -o errexit
set -o nounset
set -o pipefail
RRH_VER="source"
RRH_BIN="."
RRH_VAR="$HOME/.cache/rrh-dev/var"
RRH_ETC="$HOME/.cache/rrh-dev/etc"

if [ $# -lt 2 ]; then
    echo "Usage: rrh-doas USER COMMAND..."
    echo "RRH unified interface for user switching."
    echo "RRH $RRH_VER"
    exit 8
fi

if [ "$(id -un)" != "$1" ]; then
    if [ -f "$RRH_ETC/cmd/doas" ]; then
        "$RRH_ETC/cmd/doas" "root" "${@:2}"
        exit $?
    else
        if command -v "sudo" >/dev/null 2>&1; then
            sudo -u "$1" "${@:2}"
            exit $?
        elif command -v "doas" >/dev/null 2>&1; then
            doas -u "$1" "${@:2}"
            exit $?
        else
            echo "sudo/doas not found, please config $RRH_ETC/cmd/doas"
            exit 13
        fi
    fi
else
    "${@:2}"
    exit $?
fi
